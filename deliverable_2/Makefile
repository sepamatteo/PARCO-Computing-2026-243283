# Compiler with MPI support
CXX = mpicxx
CC  = mpicc

# Compiler flags
CXXFLAGS = -O3 -std=c++11 -Wall -fopenmp -Wextra -pedantic -Iinclude -MMD -MP
CFLAGS   = -O3 -Wall -Wextra -pedantic -Iinclude -MMD -MP
LDFLAGS  = -fopenmp

# Directories
SRC_DIR    = src
OUTPUT_DIR = outputs
DEP_DIR    = $(OUTPUT_DIR)/deps

# Target executable
TARGET = $(OUTPUT_DIR)/spmv_mpi

# Source files (C++ and C)
CXX_SRCS = \
    $(SRC_DIR)/main_mpi.cpp \
    $(SRC_DIR)/matrix_io.cpp \
    $(SRC_DIR)/distribution.cpp \
    $(SRC_DIR)/communication.cpp \
    $(SRC_DIR)/spmv_local.cpp

C_SRCS = $(SRC_DIR)/mmio.c

# Object files
CXX_OBJS = $(CXX_SRCS:$(SRC_DIR)/%.cpp=$(OUTPUT_DIR)/%.o)
C_OBJS   = $(C_SRCS:$(SRC_DIR)/%.c=$(OUTPUT_DIR)/%.o)
OBJS     = $(CXX_OBJS) $(C_OBJS)

# Dependency files (generated by -MMD)
DEPS = $(OBJS:.o=.d)

# Default target
all: $(TARGET)

# Link the executable
$(TARGET): $(OBJS) | $(OUTPUT_DIR)
	$(CXX) $(CXXFLAGS) -o $@ $(OBJS)

# Compile C++ sources
$(OUTPUT_DIR)/%.o: $(SRC_DIR)/%.cpp | $(OUTPUT_DIR)
	$(CXX) $(CXXFLAGS) -c $< -o $@

# Compile C sources
$(OUTPUT_DIR)/%.o: $(SRC_DIR)/%.c | $(OUTPUT_DIR)
	$(CC) $(CFLAGS) -c $< -o $@

# Create output directory if needed
$(OUTPUT_DIR):
	mkdir -p $(OUTPUT_DIR)

# Include generated dependency files (ignore if not yet created)
-include $(DEPS)

# Clean up
clean:
	rm -rf $(OUTPUT_DIR)/*

# Phony targets
.PHONY: all clean

# Prevent make from treating these as files
.PHONY: $(OUTPUT_DIR)
